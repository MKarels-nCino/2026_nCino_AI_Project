{% extends "base.html" %}

{% block title %}My Reservations - Wipeout & Chill{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-2">
            <i class="bi bi-bookmark"></i> My Reservations
        </h1>
        <p class="text-muted mb-4">Your upcoming adventures and active checkouts! üèÑ‚Äç‚ôÇÔ∏è</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-calendar-check"></i> All Reservations</h5>
            </div>
            <div class="card-body">
                {% if all_items %}
                <div class="list-group">
                    {% for item in all_items %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="mb-1">
                                    {% if item.board %}
                                        {{ item.board.name }}
                                        {% if item.board.brand %}<br><small class="text-muted">{{ item.board.brand }}</small>{% endif %}
                                    {% else %}
                                        Board Reservation
                                    {% endif %}
                                </h5>
                                <div class="mb-2">
                                    {% if item.is_checkout %}
                                        {% if item.display_status == 'scheduled' %}
                                            <p class="mb-1">
                                                <strong>Checkout Time:</strong> 
                                                {{ timezone_service.format_datetime_12hour(item.checkout_time, item.board.location_id if item.board else None, item.location.name if item.location else None) if item.checkout_time else 'N/A' }}
                                            </p>
                                            <p class="mb-1">
                                                <strong>Expected Return:</strong> 
                                                {{ timezone_service.format_datetime_12hour(item.expected_return_time, item.board.location_id if item.board else None, item.location.name if item.location else None) if item.expected_return_time else 'N/A' }}
                                            </p>
                                        {% else %}
                                            <p class="mb-1">
                                                <strong>Checked Out:</strong> 
                                                {{ timezone_service.format_datetime_12hour(item.checkout_time, item.board.location_id if item.board else None, item.location.name if item.location else None) if item.checkout_time else 'N/A' }}
                                            </p>
                                            <p class="mb-1">
                                                <strong>Expected Return:</strong> 
                                                {{ timezone_service.format_datetime_12hour(item.expected_return_time, item.board.location_id if item.board else None, item.location.name if item.location else None) if item.expected_return_time else 'N/A' }}
                                            </p>
                                        {% endif %}
                                    {% else %}
                                        <p class="mb-1">
                                            <strong>Unlock Time:</strong> 
                                            {{ timezone_service.format_datetime_12hour(item.unlock_time, item.board.location_id if item.board else None, item.location.name if item.location else None) if item.unlock_time else 'N/A' }}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex flex-column align-items-end gap-2">
                                {% if item.is_checkout %}
                                    {% if item.display_status == 'scheduled' %}
                                        <span class="badge scheduled-badge">
                                            <i class="bi bi-calendar-check"></i> Scheduled
                                        </span>
                                        <button class="btn btn-sm btn-danger cancel-checkout-btn mt-1" data-checkout-id="{{ item.id }}" data-board-name="{{ item.board.name if item.board else 'Board' }}">
                                            <i class="bi bi-x-circle"></i> Cancel
                                        </button>
                                    {% else %}
                                        <span class="badge in-use-badge">
                                            <i class="bi bi-check-circle"></i> In Use
                                        </span>
                                        <button class="btn btn-sm btn-success return-btn" data-checkout-id="{{ item.id }}" data-board-id="{{ item.board_id if item.board else '' }}">
                                            <i class="bi bi-arrow-return-left"></i> Return
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-{% if item.status == 'pending' %}warning{% elif item.status == 'available' %}success{% elif item.status == 'fulfilled' %}info{% else %}secondary{% endif %}">
                                        {{ item.status|title }}
                                    </span>
                                    {% if item.status == 'available' %}
                                    <button class="btn btn-sm btn-primary fulfill-btn" data-reservation-id="{{ item.id }}">
                                        <i class="bi bi-check-circle"></i> Fulfill Reservation
                                    </button>
                                    {% endif %}
                                    {% if item.status in ['pending', 'available'] %}
                                    <button class="btn btn-sm btn-danger cancel-reservation-btn mt-1" data-reservation-id="{{ item.id }}" data-board-name="{{ item.board.name if item.board else 'Board' }}">
                                        <i class="bi bi-x-circle"></i> Cancel
                                    </button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-calendar-x" style="font-size: 4rem; color: #6c757d;"></i>
                    <h4 class="mt-3 text-muted">No reservations yet</h4>
                    <p class="text-muted">Head to the <a href="{{ url_for('user_routes.dashboard') }}">Dashboard</a> to find your perfect board!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Rating Modal -->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-teal text-white">
                <h5 class="modal-title" id="ratingModalLabel">
                    <i class="bi bi-star-fill"></i> Rate Your Experience
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ratingForm">
                    <input type="hidden" id="ratingCheckoutId" name="checkout_id">
                    <input type="hidden" id="ratingBoardId" name="board_id">
                    
                    <div class="mb-3">
                        <label class="form-label">How was your experience? <span class="text-danger">*</span></label>
                        <div class="star-rating">
                            <input type="radio" id="star5" name="rating" value="5" required>
                            <label for="star5" class="star-label">‚òÖ</label>
                            <input type="radio" id="star4" name="rating" value="4" required>
                            <label for="star4" class="star-label">‚òÖ</label>
                            <input type="radio" id="star3" name="rating" value="3" required>
                            <label for="star3" class="star-label">‚òÖ</label>
                            <input type="radio" id="star2" name="rating" value="2" required>
                            <label for="star2" class="star-label">‚òÖ</label>
                            <input type="radio" id="star1" name="rating" value="1" required>
                            <label for="star1" class="star-label">‚òÖ</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reviewText" class="form-label">Tell us about your experience (optional)</label>
                        <textarea class="form-control" id="reviewText" name="review" rows="4" placeholder="How was the board? Any tips for other surfers?"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Report Damage?</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hasDamage" name="has_damage">
                            <label class="form-check-label" for="hasDamage">
                                Yes, I noticed damage to the board
                            </label>
                        </div>
                        <div id="damageDescription" style="display: none;" class="mt-2">
                            <textarea class="form-control" id="damageDescText" name="damage_description" rows="2" placeholder="Describe the damage..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-teal" id="submitRatingBtn">
                    <i class="bi bi-check-circle"></i> Submit Rating & Return
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Reservation Modal -->
<div class="modal fade" id="cancelReservationModal" tabindex="-1" aria-labelledby="cancelReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelReservationModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Cancel Reservation?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel your reservation for <strong id="cancelBoardName"></strong>?</p>
                <p class="text-danger"><strong>Warning:</strong> Once cancelled, there is no guarantee this board will be available at your desired date, time, and location.</p>
                <input type="hidden" id="cancelReservationId">
                <input type="hidden" id="cancelIsCheckout">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep It</button>
                <button type="button" class="btn btn-danger" id="confirmCancelReservationBtn">
                    <i class="bi bi-x-circle"></i> Yes, Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Return button handler with rating prompt
document.addEventListener('click', function(e) {
    if (e.target.closest('.return-btn')) {
        const btn = e.target.closest('.return-btn');
        const checkoutId = btn.dataset.checkoutId;
        const boardId = btn.dataset.boardId;
        
        // Show rating modal
        document.getElementById('ratingCheckoutId').value = checkoutId;
        document.getElementById('ratingBoardId').value = boardId;
        const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
        ratingModal.show();
    }
});

// Damage checkbox handler
document.getElementById('hasDamage').addEventListener('change', function() {
    const damageDesc = document.getElementById('damageDescription');
    damageDesc.style.display = this.checked ? 'block' : 'none';
});

// Star rating interaction
document.querySelectorAll('.star-rating input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const rating = parseInt(this.value);
        const labels = document.querySelectorAll('.star-label');
        labels.forEach((label, index) => {
            if (index < rating) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        });
    });
});

// Submit rating and return
document.getElementById('submitRatingBtn').addEventListener('click', function() {
    const form = document.getElementById('ratingForm');
    const formData = new FormData(form);
    
    const rating = formData.get('rating');
    if (!rating) {
        alert('Please select a rating');
        return;
    }
    
    const checkoutId = formData.get('checkout_id');
    const review = formData.get('review');
    const hasDamage = formData.get('has_damage') === 'on';
    const damageDescription = formData.get('damage_description');
    
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    fetch(`/api/return/${checkoutId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            rating: rating,
            review: review,
            has_damage: hasDamage,
            damage_description: damageDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof showToast === 'function') {
                showToast('üéâ Board returned and rated! Thanks for your feedback!', 'success');
            }
            const ratingModal = bootstrap.Modal.getInstance(document.getElementById('ratingModal'));
            if (ratingModal) ratingModal.hide();
            window.location.reload();
        } else {
            throw new Error(data.error || 'Return failed');
        }
    })
    .catch(error => {
        console.error('Return error:', error);
        if (typeof showToast === 'function') {
            showToast(`Return failed: ${error.message}`, 'error');
        }
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-check-circle"></i> Submit Rating & Return';
    });
});

// Cancel reservation/checkout handler
document.addEventListener('click', function(e) {
    if (e.target.closest('.cancel-reservation-btn') || e.target.closest('.cancel-checkout-btn')) {
        const btn = e.target.closest('.cancel-reservation-btn') || e.target.closest('.cancel-checkout-btn');
        const itemId = btn.dataset.reservationId || btn.dataset.checkoutId;
        const boardName = btn.dataset.boardName;
        const isCheckout = !!btn.dataset.checkoutId;

        document.getElementById('cancelBoardName').textContent = boardName;
        document.getElementById('cancelReservationId').value = itemId;
        document.getElementById('cancelIsCheckout').value = isCheckout ? 'true' : 'false';

        const cancelModal = new bootstrap.Modal(document.getElementById('cancelReservationModal'));
        cancelModal.show();
    }
});

document.getElementById('confirmCancelReservationBtn').addEventListener('click', function() {
    const itemId = document.getElementById('cancelReservationId').value;
    const isCheckout = document.getElementById('cancelIsCheckout').value === 'true';
    const endpoint = isCheckout ? `/api/cancel-checkout/${itemId}` : `/api/cancel-reservation/${itemId}`;
    
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Cancelling...';
    
    fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof showToast === 'function') {
                showToast('‚úÖ Reservation cancelled successfully!', 'success');
            }
            const cancelModal = bootstrap.Modal.getInstance(document.getElementById('cancelReservationModal'));
            if (cancelModal) cancelModal.hide();
            window.location.reload();
        } else {
            throw new Error(data.error || 'Cancel failed');
        }
    })
    .catch(error => {
        console.error('Cancel error:', error);
        if (typeof showToast === 'function') {
            showToast(`Cancellation failed: ${error.message}`, 'error');
        }
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-x-circle"></i> Yes, Cancel';
    });
});

// Fulfill reservation handler
document.addEventListener('click', function(e) {
    if (e.target.closest('.fulfill-btn')) {
        const btn = e.target.closest('.fulfill-btn');
        const reservationId = btn.dataset.reservationId;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
        
        fetch(`/api/fulfill-reservation/${reservationId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (typeof showToast === 'function') {
                    showToast('üèÑ Reservation fulfilled! Enjoy your ride!', 'success');
                }
                window.location.reload();
            } else {
                throw new Error(data.error || 'Fulfillment failed');
            }
        })
        .catch(error => {
            console.error('Fulfill error:', error);
            if (typeof showToast === 'function') {
                showToast(`Fulfillment failed: ${error.message}`, 'error');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Fulfill Reservation';
        });
    }
});
</script>
{% endblock %}
