{% extends "base.html" %}

{% block title %}Dashboard - Wipeout & Chill{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-house"></i> Dashboard
                </h1>
                <p class="text-muted mb-0">Welcome back! Ready to catch some waves? üèÑ‚Äç‚ôÇÔ∏è You don't have to be a pro to have fun!</p>
            </div>
            <div>
                <form method="POST" action="{{ url_for('user_routes.switch_location') }}" class="d-inline">
                    <select name="location_id" class="form-select form-select-sm" onchange="this.form.submit()">
                        {% for location in all_locations %}
                        <option value="{{ location.id }}" {% if location.id == selected_location_id %}selected{% endif %}>
                            {{ location.name }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Date/Time Picker Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <!-- Row 1: Title and Clear button -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <label class="form-label mb-0 d-flex align-items-center">
                        <i class="bi bi-calendar-event me-2"></i><strong>Select Checkout Date & Time</strong>
                    </label>
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="clearDateTimeBtn">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
                <!-- Row 2: Date, Hour, Duration fields -->
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="checkoutDate" class="form-label mb-1">Date</label>
                        <input type="date" 
                               class="form-control" 
                               id="checkoutDate" 
                               name="checkout_date"
                               value="{{ selected_date if selected_date else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label for="checkoutHour" class="form-label mb-1">Start Hour</label>
                        <select class="form-select" id="checkoutHour" name="checkout_hour">
                            <option value="1" {% if selected_hour == '1' %}selected{% endif %}>1:00 AM</option>
                            <option value="2" {% if selected_hour == '2' %}selected{% endif %}>2:00 AM</option>
                            <option value="3" {% if selected_hour == '3' %}selected{% endif %}>3:00 AM</option>
                            <option value="4" {% if selected_hour == '4' %}selected{% endif %}>4:00 AM</option>
                            <option value="5" {% if selected_hour == '5' %}selected{% endif %}>5:00 AM</option>
                            <option value="6" {% if selected_hour == '6' %}selected{% endif %}>6:00 AM</option>
                            <option value="7" {% if selected_hour == '7' %}selected{% endif %}>7:00 AM</option>
                            <option value="8" {% if selected_hour == '8' %}selected{% endif %}>8:00 AM</option>
                            <option value="9" {% if selected_hour == '9' %}selected{% endif %}>9:00 AM</option>
                            <option value="10" {% if selected_hour == '10' %}selected{% endif %}>10:00 AM</option>
                            <option value="11" {% if selected_hour == '11' %}selected{% endif %}>11:00 AM</option>
                            <option value="12" {% if selected_hour == '12' %}selected{% endif %}>12:00 PM</option>
                            <option value="13" {% if selected_hour == '13' %}selected{% endif %}>1:00 PM</option>
                            <option value="14" {% if selected_hour == '14' %}selected{% endif %}>2:00 PM</option>
                            <option value="15" {% if selected_hour == '15' %}selected{% endif %}>3:00 PM</option>
                            <option value="16" {% if selected_hour == '16' %}selected{% endif %}>4:00 PM</option>
                            <option value="17" {% if selected_hour == '17' %}selected{% endif %}>5:00 PM</option>
                            <option value="18" {% if selected_hour == '18' %}selected{% endif %}>6:00 PM</option>
                            <option value="19" {% if selected_hour == '19' %}selected{% endif %}>7:00 PM</option>
                            <option value="20" {% if selected_hour == '20' %}selected{% endif %}>8:00 PM</option>
                            <option value="21" {% if selected_hour == '21' %}selected{% endif %}>9:00 PM</option>
                            <option value="22" {% if selected_hour == '22' %}selected{% endif %}>10:00 PM</option>
                            <option value="23" {% if selected_hour == '23' %}selected{% endif %}>11:00 PM</option>
                            <option value="0" {% if selected_hour == '0' %}selected{% endif %}>12:00 AM</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="checkoutDuration" class="form-label mb-1">Duration</label>
                        <select class="form-select" id="checkoutDuration" name="checkout_duration">
                            {% for i in range(1, 25) %}
                            <option value="{{ i }}" {% if selected_duration == i|string %}selected{% endif %}>{{ i }} hour{% if i > 1 %}s{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Available Boards Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">Boards Ready to Ride! <span class="text-muted" style="font-size: 0.6em;">{{ current_location.name if current_location else '' }}</span></h2>
        </div>
        {% if available_boards %}
        <div class="row g-4">
            {% for board in available_boards %}
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card board-card shadow-sm h-100 {% if not board.availability_at_time %}unavailable{% endif %}" data-board-id="{{ board.id }}">
                    {% if board.image_url %}
                    <img src="{{ url_for('static', filename=board.image_url) }}" 
                         class="card-img-top" 
                         alt="{{ board.name }}"
                         style="height: 200px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="bi bi-image" style="font-size: 3rem; color: #ccc;"></i>
                    </div>
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-center">{{ board.name }}</h5>
                        <div class="text-center mb-2">
                            {% if board.availability_at_time %}
                            <span class="badge bg-success" style="font-size: 0.65em; padding: 0.35em 0.6em; display: inline-block; white-space: nowrap;">
                                <i class="bi bi-check-circle"></i> Available
                            </span>
                            {% else %}
                            <span class="badge bg-danger" style="font-size: 0.65em; padding: 0.35em 0.6em; display: inline-block; white-space: nowrap;">
                                <i class="bi bi-x-circle"></i> {{ board.availability_reason or 'Not Available' }}
                            </span>
                            {% endif %}
                        </div>
                        <!-- Board Rating Display -->
                        <div class="text-center mb-2">
                            {% if board.rating_count > 0 %}
                            <span class="board-rating" title="{{ board.rating_count }} review{% if board.rating_count != 1 %}s{% endif %}">
                                {% for i in range(1, 6) %}
                                    {% if i <= board.avg_rating|round %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                    {% elif i - 0.5 <= board.avg_rating %}
                                    <i class="bi bi-star-half text-warning"></i>
                                    {% else %}
                                    <i class="bi bi-star text-muted"></i>
                                    {% endif %}
                                {% endfor %}
                                <small class="text-muted ms-1">({{ board.rating_count }})</small>
                            </span>
                            {% else %}
                            <small class="text-muted"><i class="bi bi-star"></i> No reviews yet</small>
                            {% endif %}
                        </div>
                        <p class="card-text flex-grow-1">
                            {% if board.brand %}<strong>{{ board.brand }}</strong><br>{% endif %}
                            {% if board.size %}<span class="text-muted">Size: {{ board.size }}</span><br>{% endif %}
                            {% if board.condition %}
                                <span class="text-muted">
                                    Condition: 
                                    {% if board.condition == 'excellent' %}
                                        <span class="text-success">Excellent</span> - Perfect for catching waves!
                                    {% elif board.condition == 'good' %}
                                        <span class="text-info">Good</span> - Ready to ride, minor wear expected
                                    {% else %}
                                        <span class="text-warning">Fair</span> - Functional with some signs of use
                                    {% endif %}
                                </span>
                            {% endif %}
                            {% if board.size %}
                                <br><small class="text-muted mt-1 d-block">
                                    {% if '10' in board.size or '9' in board.size %}
                                        Great for beginners - stable and easy to balance
                                    {% elif '8' in board.size %}
                                        Perfect for intermediate surfers - good balance of stability and maneuverability
                                    {% elif '7' in board.size %}
                                        Advanced board - fast and responsive for experienced riders
                                    {% else %}
                                        Versatile board suitable for various skill levels
                                    {% endif %}
                                </small>
                            {% endif %}
                        </p>
                        <div class="cart-error-message" id="error-{{ board.id }}" style="display: none; margin-bottom: 0.5rem;">
                            <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin-bottom: 0; padding: 0.5rem;">
                                <small id="error-text-{{ board.id }}"></small>
                                <button type="button" class="btn-close" style="font-size: 0.7rem; padding: 0.25rem;" onclick="document.getElementById('error-{{ board.id }}').style.display='none'"></button>
                            </div>
                        </div>
                        {% set in_cart = board.id in session.get('cart', []) %}
                        {% if in_cart %}
                        <button class="btn btn-outline-success add-to-cart-btn w-100 mt-auto" 
                                data-board-id="{{ board.id }}"
                                disabled
                                style="cursor: not-allowed;">
                            <i class="bi bi-check-circle"></i> In Cart
                        </button>
                        {% elif not board.availability_at_time %}
                        <button class="btn btn-secondary add-to-cart-btn w-100 mt-auto" 
                                data-board-id="{{ board.id }}"
                                disabled
                                style="cursor: not-allowed;">
                            <i class="bi bi-x-circle"></i> Not Available
                        </button>
                        {% else %}
                        <button class="btn btn-primary add-to-cart-btn w-100 mt-auto" 
                                data-board-id="{{ board.id }}">
                            <i class="bi bi-cart-plus"></i> Add to Cart
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="bi bi-emoji-frown" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">No boards available right now. But don't worry - more waves (and boards) are coming!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- My Reservations Section (Combined) -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-bookmark"></i> My Reservations (Your Next Adventure Awaits!)</h5>
            </div>
            <div class="card-body">
                {% if all_items %}
                <div class="list-group">
                    {% for item in all_items %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <!-- Left side: Board info -->
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    {% if item.is_checkout and item.board %}
                                        {{ item.board.name }}
                                        {% if item.board.brand %}<br><small class="text-muted">{{ item.board.brand }}</small>{% endif %}
                                    {% elif item.board %}
                                        Board Reservation<br><small class="text-muted">{{ item.board.name }}</small>
                                    {% else %}
                                        Board Reservation
                                    {% endif %}
                                </h6>
                                <div class="mb-0">
                                    {% if item.is_checkout %}
                                        {% if item.display_status == 'scheduled' %}
                                            <p class="mb-1">
                                                <strong>Checkout Time:</strong> 
                                                {{ timezone_service.format_datetime_12hour(item.checkout_time, item.board.location_id if item.board else selected_location_id, item.location.name if item.location else None) if item.checkout_time else 'N/A' }}
                                            </p>
                                            <p class="mb-0">
                                                <strong>Expected Return:</strong> 
                                                {{ timezone_service.format_datetime_12hour(item.expected_return_time, item.board.location_id if item.board else selected_location_id, item.location.name if item.location else None) if item.expected_return_time else 'N/A' }}
                                            </p>
                                        {% else %}
                                            <p class="mb-1">
                                                <strong>Checked Out:</strong> 
                                                {{ timezone_service.format_datetime_12hour(item.checkout_time, item.board.location_id if item.board else selected_location_id, item.location.name if item.location else None) if item.checkout_time else 'N/A' }}
                                            </p>
                                            <p class="mb-0">
                                                <strong>Expected Return:</strong> 
                                                {{ timezone_service.format_datetime_12hour(item.expected_return_time, item.board.location_id if item.board else selected_location_id, item.location.name if item.location else None) if item.expected_return_time else 'N/A' }}
                                            </p>
                                        {% endif %}
                                    {% else %}
                                        <p class="mb-0">
                                            <strong>Unlock Time:</strong> 
                                            {{ timezone_service.format_datetime_12hour(item.unlock_time, item.board.location_id if item.board else selected_location_id, item.location.name if item.location else None) if item.unlock_time else 'N/A' }}
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Right side: Badge at top, buttons at bottom -->
                            <div class="d-flex flex-column justify-content-between align-items-end ms-3" style="min-height: 80px;">
                                <!-- Badge at top -->
                                {% if item.is_checkout %}
                                    {% if item.display_status == 'scheduled' %}
                                        <span class="badge scheduled-badge">
                                            <i class="bi bi-calendar-check"></i> Scheduled
                                        </span>
                                    {% else %}
                                        <span class="badge in-use-badge">
                                            <i class="bi bi-water"></i> Active
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-{% if item.status == 'pending' %}warning{% elif item.status == 'available' %}success{% elif item.status == 'fulfilled' %}info{% else %}secondary{% endif %}">
                                        {{ item.status|title }}
                                    </span>
                                {% endif %}
                                
                                <!-- Buttons at bottom -->
                                {% if item.is_checkout %}
                                    {% if item.display_status == 'scheduled' %}
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-teal activate-checkout-btn" data-checkout-id="{{ item.id }}" data-board-name="{{ item.board.name if item.board else 'Board' }}" style="min-width: 85px;">
                                                <i class="bi bi-play-circle"></i> Activate
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger cancel-checkout-btn" data-checkout-id="{{ item.id }}" data-board-name="{{ item.board.name if item.board else 'Board' }}" style="min-width: 85px;">
                                                <i class="bi bi-x-circle"></i> Cancel
                                            </button>
                                        </div>
                                    {% else %}
                                        <button class="btn btn-sm btn-success return-btn" data-checkout-id="{{ item.id }}" data-board-id="{{ item.board_id if item.board else '' }}">
                                            <i class="bi bi-arrow-return-left"></i> Return
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <div class="d-flex gap-2">
                                        {% if item.status == 'available' %}
                                        <button class="btn btn-sm btn-primary fulfill-btn" data-reservation-id="{{ item.id }}">
                                            <i class="bi bi-check-circle"></i> Fulfill
                                        </button>
                                        {% endif %}
                                        {% if item.status in ['pending', 'available'] %}
                                        <button class="btn btn-sm btn-outline-danger cancel-reservation-btn" data-reservation-id="{{ item.id }}" data-board-name="{{ item.board.name if item.board else 'Board' }}">
                                            <i class="bi bi-x-circle"></i> Cancel
                                        </button>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-calendar-check" style="font-size: 3rem; color: #6c757d;"></i>
                    <p class="text-muted mt-2">No reservations yet. When a board catches your eye, reserve it for your next wipeout session!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Activate Reservation Modal -->
<div class="modal fade" id="activateReservationModal" tabindex="-1" aria-labelledby="activateReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-teal text-white">
                <h5 class="modal-title" id="activateReservationModalLabel">
                    <i class="bi bi-play-circle"></i> Activate Reservation?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Ready to hit the waves with <span id="activateBoardName"></span>?</strong></p>
                <p class="text-muted">
                    Activating this reservation means you're picking up the board now. 
                    The timer starts and you'll need to return it before the expected return time.
                </p>
                <div class="alert alert-success">
                    <i class="bi bi-water"></i>
                    <small>Once activated, you can return the board and rate your experience!</small>
                </div>
                <input type="hidden" id="activateCheckoutId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Not Yet</button>
                <button type="button" class="btn btn-teal" id="confirmActivateBtn">
                    <i class="bi bi-play-circle"></i> Yes, Activate Now!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Reservation Modal -->
<div class="modal fade" id="cancelReservationModal" tabindex="-1" aria-labelledby="cancelReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="cancelReservationModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Cancel Reservation?
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Are you sure you want to cancel this reservation?</strong></p>
                <p class="text-muted">
                    Once cancelled, there is no guarantee this board will be available to you at the desired date, time, and location. 
                    Other users may reserve it, and availability cannot be guaranteed.
                </p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <small>You can always make a new reservation if the board becomes available again.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Reservation</button>
                <button type="button" class="btn btn-danger" id="confirmCancelReservationBtn">
                    <i class="bi bi-x-circle"></i> Yes, Cancel Reservation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rating Modal -->
<div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-teal text-white">
                <h5 class="modal-title" id="ratingModalLabel">
                    <i class="bi bi-star-fill"></i> Rate Your Experience
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ratingForm">
                    <input type="hidden" id="ratingCheckoutId" name="checkout_id">
                    <input type="hidden" id="ratingBoardId" name="board_id">
                    
                    <div class="mb-3">
                        <label class="form-label">How was your experience? <span class="text-danger">*</span></label>
                        <div class="star-rating">
                            <input type="radio" id="star5" name="rating" value="5" required>
                            <label for="star5" class="star-label">‚òÖ</label>
                            <input type="radio" id="star4" name="rating" value="4" required>
                            <label for="star4" class="star-label">‚òÖ</label>
                            <input type="radio" id="star3" name="rating" value="3" required>
                            <label for="star3" class="star-label">‚òÖ</label>
                            <input type="radio" id="star2" name="rating" value="2" required>
                            <label for="star2" class="star-label">‚òÖ</label>
                            <input type="radio" id="star1" name="rating" value="1" required>
                            <label for="star1" class="star-label">‚òÖ</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reviewText" class="form-label">Tell us about your experience (optional)</label>
                        <textarea class="form-control" id="reviewText" name="review" rows="4" placeholder="How was the board? Any tips for other surfers?"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Report Damage?</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hasDamage" name="has_damage">
                            <label class="form-check-label" for="hasDamage">
                                Yes, I noticed damage to the board
                            </label>
                        </div>
                        <div id="damageDescription" style="display: none;" class="mt-2">
                            <textarea class="form-control" id="damageDescText" name="damage_description" rows="2" placeholder="Describe the damage..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-teal" id="submitRatingBtn">
                    <i class="bi bi-check-circle"></i> Submit Rating & Return
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/user_dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/cart_handler.js') }}"></script>
<script>
// Date/Time picker handler - Dynamic updates
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('checkoutDate');
    const hourSelect = document.getElementById('checkoutHour');
    const durationSelect = document.getElementById('checkoutDuration');
    const clearBtn = document.getElementById('clearDateTimeBtn');
    
    function applyDateTimeFilter() {
        const selectedDate = dateInput ? dateInput.value : '';
        const selectedHour = hourSelect ? hourSelect.value : '';
        const selectedDuration = durationSelect ? durationSelect.value : '1';
        
        if (selectedDate && selectedHour) {
            // Reload page with selected date, hour, and duration as query parameters
            const url = new URL(window.location.href);
            url.searchParams.set('selected_date', selectedDate);
            url.searchParams.set('selected_hour', selectedHour);
            url.searchParams.set('selected_duration', selectedDuration);
            window.location.href = url.toString();
        }
    }
    
    // Auto-apply when date, hour, or duration changes
    if (dateInput) {
        dateInput.addEventListener('change', function() {
            if (this.value && hourSelect && hourSelect.value) {
                applyDateTimeFilter();
            }
        });
    }
    
    if (hourSelect) {
        hourSelect.addEventListener('change', function() {
            if (this.value && dateInput && dateInput.value) {
                applyDateTimeFilter();
            }
        });
    }
    
    if (durationSelect) {
        durationSelect.addEventListener('change', function() {
            if (dateInput && dateInput.value && hourSelect && hourSelect.value) {
                applyDateTimeFilter();
            }
        });
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            if (dateInput) dateInput.value = '';
            if (hourSelect) hourSelect.value = '8'; // Reset to 8 AM
            if (durationSelect) durationSelect.value = '1';
            // Reload page without datetime parameters (will use default)
            const url = new URL(window.location.href);
            url.searchParams.delete('selected_date');
            url.searchParams.delete('selected_hour');
            url.searchParams.delete('selected_duration');
            window.location.href = url.toString();
        });
    }
});

// Cancel reservation/checkout handler
let cancelReservationId = null;
let cancelCheckoutId = null;
let isCancellingCheckout = false;

document.addEventListener('click', function(e) {
    if (e.target.closest('.cancel-reservation-btn')) {
        const btn = e.target.closest('.cancel-reservation-btn');
        cancelReservationId = btn.dataset.reservationId;
        cancelCheckoutId = null;
        isCancellingCheckout = false;
        const boardName = btn.dataset.boardName || 'this board';
        
        // Show cancel confirmation modal
        const cancelModal = new bootstrap.Modal(document.getElementById('cancelReservationModal'));
        cancelModal.show();
    }
    
    if (e.target.closest('.cancel-checkout-btn')) {
        const btn = e.target.closest('.cancel-checkout-btn');
        cancelCheckoutId = btn.dataset.checkoutId;
        cancelReservationId = null;
        isCancellingCheckout = true;
        const boardName = btn.dataset.boardName || 'this board';
        
        // Show cancel confirmation modal
        const cancelModal = new bootstrap.Modal(document.getElementById('cancelReservationModal'));
        cancelModal.show();
    }
});

// Confirm cancel reservation/checkout
document.getElementById('confirmCancelReservationBtn').addEventListener('click', function() {
    if (!cancelReservationId && !cancelCheckoutId) return;
    
    // Disable button
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Cancelling...';
    
    const url = isCancellingCheckout 
        ? `/api/cancel-checkout/${cancelCheckoutId}`
        : `/api/cancel-reservation/${cancelReservationId}`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('cancelReservationModal')).hide();
            
            if (typeof showToast === 'function') {
                const message = isCancellingCheckout 
                    ? 'Checkout cancelled successfully' 
                    : 'Reservation cancelled successfully';
                showToast(message, 'success');
            }
            
            // Reload reservations section
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            throw new Error(data.error || 'Cancel failed');
        }
    })
    .catch(error => {
        console.error('Cancel error:', error);
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-x-circle"></i> Yes, Cancel Reservation';
        if (typeof showToast === 'function') {
            showToast(`Failed to cancel: ${error.message}`, 'error');
        }
    });
});

// Activate reservation handler
document.addEventListener('click', function(e) {
    if (e.target.closest('.activate-checkout-btn')) {
        const btn = e.target.closest('.activate-checkout-btn');
        const checkoutId = btn.dataset.checkoutId;
        const boardName = btn.dataset.boardName || 'this board';
        
        // Show activate confirmation modal
        document.getElementById('activateCheckoutId').value = checkoutId;
        document.getElementById('activateBoardName').textContent = boardName;
        const activateModal = new bootstrap.Modal(document.getElementById('activateReservationModal'));
        activateModal.show();
    }
});

// Confirm activate reservation
document.getElementById('confirmActivateBtn').addEventListener('click', function() {
    const checkoutId = document.getElementById('activateCheckoutId').value;
    
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Activating...';
    
    fetch(`/api/activate-checkout/${checkoutId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('activateReservationModal')).hide();
            
            if (typeof showToast === 'function') {
                showToast('üèÑ Board activated! Enjoy your ride!', 'success');
            }
            
            // Reload page
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            throw new Error(data.error || 'Activation failed');
        }
    })
    .catch(error => {
        console.error('Activate error:', error);
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-play-circle"></i> Yes, Activate Now!';
        if (typeof showToast === 'function') {
            showToast(`Failed to activate: ${error.message}`, 'error');
        }
    });
});

// Return button handler with rating prompt
document.addEventListener('click', function(e) {
    if (e.target.closest('.return-btn')) {
        const btn = e.target.closest('.return-btn');
        const checkoutId = btn.dataset.checkoutId;
        const boardId = btn.dataset.boardId;
        
        // Show rating modal
        document.getElementById('ratingCheckoutId').value = checkoutId;
        document.getElementById('ratingBoardId').value = boardId;
        const ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
        ratingModal.show();
    }
});

// Damage checkbox handler
document.getElementById('hasDamage').addEventListener('change', function() {
    const damageDesc = document.getElementById('damageDescription');
    damageDesc.style.display = this.checked ? 'block' : 'none';
});

// Star rating interaction - CSS handles the visual with :checked selector
// Just need to clear any manually added 'active' classes when selection changes
document.querySelectorAll('.star-rating input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // Remove all active classes - let CSS :checked handle the highlighting
        document.querySelectorAll('.star-label').forEach(label => {
            label.classList.remove('active');
        });
    });
});

// Submit rating and return
document.getElementById('submitRatingBtn').addEventListener('click', function() {
    const form = document.getElementById('ratingForm');
    const formData = new FormData(form);
    
    const rating = formData.get('rating');
    if (!rating) {
        alert('Please select a rating');
        return;
    }
    
    const checkoutId = formData.get('checkout_id');
    const boardId = formData.get('board_id');
    const review = formData.get('review');
    const hasDamage = formData.get('has_damage') === 'on';
    const damageDescription = formData.get('damage_description');
    
    // Disable button
    this.disabled = true;
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    // Return board with rating
    fetch(`/api/return/${checkoutId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            has_damage: hasDamage,
            damage_description: hasDamage ? damageDescription : null,
            rating: parseInt(rating),
            review: review || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('ratingModal')).hide();
            
            if (typeof showToast === 'function') {
                showToast('üèÑ Board returned! Thanks for your feedback!', 'success');
            }
            
            // Reload page
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.error || 'Return failed');
        }
    })
    .catch(error => {
        console.error('Return error:', error);
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-check-circle"></i> Submit Rating & Return';
        if (typeof showToast === 'function') {
            showToast(`Return failed: ${error.message}`, 'error');
        }
    });
});
</script>
{% endblock %}
